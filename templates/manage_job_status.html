{% extends "base.html" %}

{% block title %}Manage Job Status - Candidate Filtration System{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="fas fa-toggle-on me-2"></i>Manage Job Status
                </h2>
                <div>
                    <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                    </a>
                    <a href="{{ url_for('manage_jobs') }}" class="btn btn-primary">
                        <i class="fas fa-briefcase me-1"></i>Full Job Management
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card border-success">
                <div class="card-body text-center">
                    <h3 class="card-title text-success">{{ status_counts.get('open', 0) }}</h3>
                    <p class="card-text">
                        <i class="fas fa-door-open me-1"></i>Open Jobs
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-secondary">
                <div class="card-body text-center">
                    <h3 class="card-title text-secondary">{{ status_counts.get('closed', 0) }}</h3>
                    <p class="card-text">
                        <i class="fas fa-door-closed me-1"></i>Closed Jobs
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-info">
                <div class="card-body text-center">
                    <h3 class="card-title text-info">{{ (status_counts.get('open', 0) + status_counts.get('closed', 0)) }}</h3>
                    <p class="card-text">
                        <i class="fas fa-briefcase me-1"></i>Total Jobs
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Actions Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-trash-alt me-2"></i>Bulk Clear Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            {% if status_counts.get('closed', 0) > 0 %}
                            <form method="post" style="display: inline;" onsubmit="return confirmClearClosed()">
                                <input type="hidden" name="action" value="clear_closed">
                                <button type="submit" class="btn btn-warning btn-lg w-100">
                                    <i class="fas fa-broom me-2"></i>Clear All Closed Jobs
                                    <span class="badge bg-dark ms-2">{{ status_counts.get('closed', 0) }}</span>
                                </button>
                            </form>
                            {% else %}
                            <button type="button" class="btn btn-outline-warning btn-lg w-100" disabled>
                                <i class="fas fa-broom me-2"></i>No Closed Jobs to Clear
                            </button>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            {% if (status_counts.get('open', 0) + status_counts.get('closed', 0)) > 0 %}
                            <form method="post" style="display: inline;" onsubmit="return confirmClearAll()">
                                <input type="hidden" name="action" value="clear_all">
                                <button type="submit" class="btn btn-danger btn-lg w-100">
                                    <i class="fas fa-trash me-2"></i>Clear ALL Jobs
                                    <span class="badge bg-light text-dark ms-2">{{ (status_counts.get('open', 0) + status_counts.get('closed', 0)) }}</span>
                                </button>
                            </form>
                            {% else %}
                            <button type="button" class="btn btn-outline-danger btn-lg w-100" disabled>
                                <i class="fas fa-trash me-2"></i>No Jobs to Clear
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Jobs List -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>All Jobs - Status Management
                    </h5>
                </div>
                <div class="card-body">
                    {% if jobs %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Job ID</th>
                                        <th>Position</th>
                                        <th>Experience</th>
                                        <th>Position Years</th>
                                        <th>Education</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for job in jobs %}
                                    <tr class="{% if job[13] == 'open' %}table-success{% else %}table-secondary{% endif %}">
                                        <td>
                                            {% if job|length > 15 and job[15] %}
                                                <span class="badge bg-dark">{{ job[15] }}</span>
                                            {% else %}
                                                <span class="badge bg-secondary">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <strong>{{ job[8] if job[8] else 'Unknown Position' }}</strong>
                                            {% if job[7] %}
                                            <br><small class="text-muted">{{ job[7][:50] }}{% if job[7]|length > 50 %}...{% endif %}</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-primary">{{ job[1] }}+ years</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-info">{{ job[9] }}+ years</span>
                                        </td>
                                        <td>
                                            <div class="text-muted">
                                                <small class="fw-bold">{{ job[3].replace('_', ' ').title() if job[3] else 'N/A' }}</small>
                                                {% if job|length > 14 and job[14] %}
                                                    <br><small class="text-secondary">of {{ job[14] }}</small>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            {% if job[13] == 'open' %}
                                                <span class="badge bg-success fs-6">
                                                    <i class="fas fa-door-open me-1"></i>OPEN
                                                </span>
                                            {% else %}
                                                <span class="badge bg-secondary fs-6">
                                                    <i class="fas fa-door-closed me-1"></i>CLOSED
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small>{{ job[5][:10] if job[5] else 'Unknown' }}</small>
                                        </td>
                                        <td>
                                            <form method="post" style="display: inline;">
                                                <input type="hidden" name="action" value="toggle_status">
                                                <input type="hidden" name="job_id" value="{{ job[0] }}">
                                                {% if job[13] == 'open' %}
                                                    <button type="submit" class="btn btn-warning btn-sm" title="Close this job">
                                                        <i class="fas fa-times me-1"></i>Close
                                                    </button>
                                                {% else %}
                                                    <button type="submit" class="btn btn-success btn-sm" title="Open this job">
                                                        <i class="fas fa-check me-1"></i>Open
                                                    </button>
                                                {% endif %}
                                            </form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-briefcase fa-3x text-muted mb-3"></i>
                            <h4 class="text-muted">No Job Criteria Found</h4>
                            <p class="text-muted">Create your first job criteria to start managing job statuses.</p>
                            <a href="{{ url_for('add_job') }}" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>Add New Job
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if jobs %}
    <!-- Quick Stats Footer -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card bg-light">
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <h6 class="text-muted">Active (Open) Jobs</h6>
                            <h4 class="text-success">{{ status_counts.get('open', 0) }}</h4>
                        </div>
                        <div class="col-md-3">
                            <h6 class="text-muted">Inactive (Closed) Jobs</h6>
                            <h4 class="text-secondary">{{ status_counts.get('closed', 0) }}</h4>
                        </div>
                        <div class="col-md-3">
                            <h6 class="text-muted">Total Job Criteria</h6>
                            <h4 class="text-info">{{ (status_counts.get('open', 0) + status_counts.get('closed', 0)) }}</h4>
                        </div>
                        <div class="col-md-3">
                            <h6 class="text-muted">Last Updated</h6>
                            <h6 class="text-muted">Today</h6>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
function confirmClearClosed() {
    return confirm('Are you sure you want to clear all CLOSED job criteria? This action cannot be undone.\n\nThis will permanently delete {{ status_counts.get("closed", 0) }} closed job(s).');
}

function confirmClearAll() {
    return confirm('⚠️ WARNING: This will delete ALL job criteria (both open and closed)!\n\nThis action cannot be undone and will permanently remove {{ (status_counts.get("open", 0) + status_counts.get("closed", 0)) }} job criteria.\n\nType "DELETE ALL" in the next prompt to confirm.');
}

// Show additional confirmation for clear all
document.querySelector('form[onsubmit="return confirmClearAll()"]').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (confirmClearAll()) {
        const confirmation = prompt('Please type "DELETE ALL" to confirm this dangerous action:');
        if (confirmation === 'DELETE ALL') {
            this.submit();
        } else {
            alert('Action cancelled. You must type "DELETE ALL" exactly to confirm.');
        }
    }
});

// Auto-refresh status every 30 seconds (optional)
setTimeout(function() {
    location.reload();
}, 30000);
</script>

{% endblock %}
